# GPU-інстансні ефекти

Цей документ описує стандартизований життєвий цикл для інстансних WebGL-ефектів на кшталт "пелюсткових" аур та віхол.

## Інтерфейс життєвого циклу

У `src/ui/renderers/primitives/gpu/GpuInstancedPrimitiveLifecycle.ts` оголошено інтерфейс `GpuInstancedPrimitiveLifecycle<TBatch>`. Він визначає мінімальний набір методів, які повинен реалізовувати менеджер GPU-ефекту:

- **`onContextAcquired(gl)`** — викликається під час ініціалізації WebGL2-контексту. Реалізація створює або переініціалізує шейдери, буфери та зберігає прив'язку контексту.
- **`ensureBatch(gl, capacity)`** — гарантує наявність або розширення інстанс-батчу під конкретний ефект і повертає його для запису сценових даних.
- **`beforeRender(gl, timestampMs)`** — виконується кожен кадр перед відправкою draw-call (наприклад, перепаковує активні інстанси чи виконує CPU-side підготовку).
- **`render(gl, cameraPosition, viewportSize, timestampMs)`** — видає draw-call. Тут встановлюються uniform'и камери та виконується власне `drawArraysInstanced`.
- **`clearInstances(gl?)`** — скидає всі активні інстанси для заданого контексту або для всіх, що відстежуються менеджером. Використовується при рестартах мапи чи переходах між сценами.
- **`onContextLost(gl)`** — звільняє ресурси, коли WebGL-контекст закривається або перевідкривається.
- **`dispose()`** — остаточне прибирання для всіх контекстів (викликається під час демонтажу сцени або вимкнення застосунку).

## Поточні реалізації

### PetalAuraEffect
Файл: `src/ui/renderers/primitives/gpu/PetalAuraGpuRenderer.ts`.

- Зберігає мапу `{ gl -> { resources, batch } }` і реалізує всі методи інтерфейсу.
- `ensureBatch` перевіряє та розширює місткість інстанс-буфера, `beforeRender` перепаковує активні пелюстки, `render` налаштовує blend та викликає `drawArraysInstanced`.
- `SceneScreen` викликає `clearInstances` під час рестарту карти або перед повторною ініціалізацією сцени, тому немає потреби у додаткових lifecycle-менеджерах.

### WhirlEffect
Файл: `src/ui/renderers/primitives/gpu/WhirlGpuRenderer.ts`.

- Має таку саму структуру управління контекстами.
- `beforeRender` викликається після `updateAllWhirlInterpolations()` і приводить активні інстанси до щільного вигляду, після чого `render` виконує один draw-call.
- `SandStormRenderer` і далі користується `ensureBatch`/`writeWhirlInstance`, але сам менеджер життєвого циклу живе всередині `WhirlEffect`.

## Інтеграція зі сценами

У `SceneScreen` менеджери підключаються так:

1. Після отримання WebGL2-контексту викликаємо `whirlEffect.onContextAcquired(webgl2)` та `petalAuraEffect.onContextAcquired(webgl2)`.
2. У кожному кадрі перед рендерингом викликаються `beforeRender` обох ефектів, а потім `render` із актуальними параметрами камери.
3. Під час очищення сцени або втрати контексту викликаємо `onContextLost` (для поточного контексту) та `dispose`, щоб звільнити всі ресурси.

Такий підхід усуває розкидані глобальні функції, робить життєвий цикл однаковим для різних GPU-ефектів і полегшує додавання нових інстансних шейдерів.
