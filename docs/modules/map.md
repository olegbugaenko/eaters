# MapModule

## Призначення
Керує вибором карт, рівнів складності та життєвим циклом забігу. Синхронізує сцену, ресурси, некроманта й юнітів.

## Залежності
- `SceneObjectManager` — відображає карту, портали, точки спавну.
- `DataBridge` — публікує списки карт (`maps/list`), вибір карти та стан автоперезапуску.
- `BricksModule` — спавнить і скидає цеглини за схемами.
- `PlayerUnitsModule` — готує та знищує юнітів при старті/завершенні.
- `NecromancerModule` — конфігурує точки виклику та завершує карту.
- `ResourcesModule` — старт/фініш забігу.
- `UnlockService` та `getSkillLevel` — визначають доступність карт та автоперезапуску.

## Життєвий цикл
- `initialize()` — обчислює стан автоперезапуску та забезпечує вибір стартової карти.
- `reset()` — скидає прапорці автоперезапуску та повторно обирає карту.
- `load(data)` — відновлює поточну карту, рівень, статистику й налаштування.

## Основні методи
- `tick(deltaMs)` — оновлює автоперезапуск і портальні ефекти.
- `selectMap(mapId)` / `selectMapLevel(mapId, level)` — обирають карту та рівень, якщо вони доступні.
- `restartSelectedMap()` — починає забіг із поточними налаштуваннями.
- `leaveCurrentMap()` — завершення забігу без запису перемоги.
- `setAutoRestartEnabled(enabled)` / `setAutoRestartThreshold(enabled, minEffectiveUnits)` — конфігурація автоперезапуску.
- `recordRunResult(result)` — оновлює статистику карт після забігу.
- `getMapStats()` — повертає копію статистики для інших систем.

## Збереження
- Зберігає поточну карту, рівень, статистику забігів, обрані рівні для кожної карти та налаштування автоперезапуску.

## Особливості
- Визначає «ефективних юнітів» як суму живих та тих, яких можна викликати за sanity, щоб автоматично перезапускати карту при фейлі.
- Під час старту викликає `startRun()` ресурсів і `prepareForMap()` юнітів, а також налаштовує некроманта на нові точки виклику.
