# PlayerUnitsModule

## Призначення
Відповідає за життєвий цикл союзних юнітів: спавн, рух, атаки, взаємодію з цеглинами та вибухами.

## Залежності
- `SceneObjectManager` — керує рендер-об'єктами юнітів.
- `BricksModule` — вибір цілей і завдання шкоди.
- `DataBridge` — публікує статистику (`playerUnits/count`, `playerUnits/totalHp`, `playerUnits/blueprintStats`).
- `MovementService` — оновлення фізики й переміщення.
- `BonusesModule` — впливає на крити, множники нагород, інші модифікатори.
- `ExplosionModule` — створює ефекти крита або смерті.
- `UnitModuleWorkshopModule` і `SkillTreeModule` (через передані функції) — визначають рівні модулів та наявність скілів.

## Життєвий цикл
- `initialize()` — публікує базову статистику.
- `reset()` — очищує сцену та скидає юнітів.
- `load(data)` — застосовує збережений склад юнітів (для відтворення стану).
- `prepareForMap()` — розраховує характеристики «blueprint» перед стартом забігу.

## Основні методи
- `tick(deltaMs)` — оновлює рух, атаку, реген, критичні ефекти, взаємодію з вибухами.
- `setUnits(units)` — повністю замінює склад (використовується для завантаження карт).
- `spawnUnit(unit)` — додає юніта у сцену та внутрішні колекції.
- `getActiveUnitCount()` — кількість активних юнітів.
- `getUnitCountByDesignId(designId)` — кількість юнітів за дизайном.
- `getUnitPositionIfAlive(unitId)` — позиція юніта, якщо він живий (використовується для ефектів та дуг).

## Збереження
Зберігає список юнітів з їх типом, позицією, HP та кулдаунами атаки. Реальний стан сцени відновлюється під час завантаження.

## Створення станів

Модуль використовує `UnitStateFactory` (наслідник `StateFactory`) для створення станів юнітів:

- **`create`**: використовує `UnitFactory` для створення базового стану, додає рівні модулів, налаштування цілеуказання та ініціалізує всі поля стану
- **`transform`**: оновлює внутрішні візуальні ефекти (наприклад, furnace effect) та пушить стан до сцени через `pushUnitSceneState`

Метод `createUnitState` використовує `unitStateFactory.createWithTransform` для створення та ініціалізації юніта.

## Особливості
- Має внутрішню систему «attack stacks», яка збільшує шкоду при серійних атаках.
- Використовує візуальні ефекти (наприклад, внутрішню піч) через `VisualEffectState`.
- Підтримує модулі, які змінюють поведінку: перенаправлення шкоди, множники винагород, критичні вибухи.
- Використовує `StateFactory` для уніфікованого створення станів (див. [state-factory.md](../overview/state-factory.md)).
